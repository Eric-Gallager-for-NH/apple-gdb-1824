--- SIOUX.c.orig	Tue Sep  5 18:01:35 2000+++ SIOUX.c	Sat Apr  6 02:22:03 2002@@ -17,6 +17,9 @@ */  #include <SIOUX.h> +_MSL_IMP_EXP_SIOUX extern short InstallConsole(short fd);+_MSL_IMP_EXP_SIOUX extern void SetupConsolePlugins(void*, void*, void*, void*, void*, void*, void*, void*);+  #include "SIOUXGlobals.h" #include "SIOUXMenus.h"@@ -41,6 +44,40 @@ #include <Traps.h>  +#define SIOUX_PLUGIN+#ifdef SIOUX_PLUGIN+static short (*Plugin_InstallConsole)(short fd) = NULL;+static void (*Plugin_RemoveConsole)(void) = NULL;+static long (*Plugin_WriteCharsToConsole)(char *buffer, long n) = NULL;+static long (*Plugin_ReadCharsFromConsole)(char *buffer, long n) = NULL;+static char *(*Plugin___ttyname)(long fildes) = NULL;+static int (*Plugin_kbhit)(void) = NULL;+static int (*Plugin_getch)(void) = NULL;+static void (*Plugin_clrscr)(void) = NULL;+#endif++void SetupConsolePlugins(	void* thePlugin_InstallConsole,+							void* thePlugin_RemoveConsole,+							void* thePlugin_WriteCharsToConsole,+							void* thePlugin_ReadCharsFromConsole,+							void* thePlugin___ttyname,+							void* thePlugin_kbhit,+							void* thePlugin_getch,+							void* thePlugin_clrscr)+{+#ifdef SIOUX_PLUGIN+	Plugin_InstallConsole = thePlugin_InstallConsole;+	Plugin_RemoveConsole = thePlugin_RemoveConsole;+	Plugin_WriteCharsToConsole = thePlugin_WriteCharsToConsole;+	Plugin_ReadCharsFromConsole = thePlugin_ReadCharsFromConsole;+	Plugin___ttyname = thePlugin___ttyname;+	Plugin_kbhit = thePlugin_kbhit;+	Plugin_getch = thePlugin_getch;+	Plugin_clrscr = thePlugin_clrscr;+#endif+}++ /*	defined in unix.c ...*/ #ifdef __cplusplus extern "C" {@@ -1070,7 +1107,7 @@ /*	Return...:	---														*/ /************************************************************************/ static pascal OSErr DoHandleOpenApplication(const AppleEvent *theEvent, AppleEvent *theReply,-	UInt32 refCon)+	long refCon) { #pragma unused(theReply, refCon) 	OSErr theErr;@@ -1109,7 +1146,7 @@ /*	Return...:	---														*/ /************************************************************************/ static pascal OSErr DoHandleOpenDocuments(const AppleEvent *theEvent, AppleEvent *theReply,-	UInt32 refCon)+	long refCon) { #pragma unused(theReply, refCon) 	OSErr theErr;@@ -1125,7 +1162,7 @@ /*	Return...:	---														*/ /************************************************************************/ static pascal OSErr DoHandlePrintDocuments(const AppleEvent *theEvent, AppleEvent *theReply,-	UInt32 refCon)+	long refCon) { #pragma unused(theReply, refCon) 	OSErr theErr;@@ -1141,7 +1178,7 @@ /*	Return...:	---														*/ /************************************************************************/ static pascal OSErr DoHandleQuit(const AppleEvent *theEvent, AppleEvent *theReply,-	UInt32 refCon)+	long refCon) { #pragma unused(theReply, refCon) 	OSErr theErr;@@ -1169,6 +1206,10 @@  #pragma unused (fd) +#ifdef SIOUX_PLUGIN+	if(Plugin_InstallConsole) return (*Plugin_InstallConsole)(fd);+#endif+ 	if (SIOUXQuitting || SIOUXState != OFF) return 0;  	if (SIOUXSettings.initializeTB && !toolBoxDone)@@ -1196,16 +1237,16 @@ #endif /* ! __MSL__ */ 		{ 			AEInstallEventHandler(kCoreEventClass, kAEOpenApplication,-				NewAEEventHandlerProc(&DoHandleOpenApplication), 0, false);+				NewAEEventHandlerUPP(&DoHandleOpenApplication), 0, false); 			 			AEInstallEventHandler(kCoreEventClass, kAEOpenDocuments,-				NewAEEventHandlerProc(&DoHandleOpenDocuments), 0, false);+				NewAEEventHandlerUPP(&DoHandleOpenDocuments), 0, false); 			 			AEInstallEventHandler(kCoreEventClass, kAEPrintDocuments,-				NewAEEventHandlerProc(&DoHandlePrintDocuments), 0, false);+				NewAEEventHandlerUPP(&DoHandlePrintDocuments), 0, false); 			 			AEInstallEventHandler(kCoreEventClass, kAEQuitApplication,-				NewAEEventHandlerProc(&DoHandleQuit), 0, false);+				NewAEEventHandlerUPP(&DoHandleQuit), 0, false); 		} 	} 	@@ -1249,6 +1290,10 @@ { 	extern int __aborting; +#ifdef SIOUX_PLUGIN+	if(Plugin_RemoveConsole) {(*Plugin_RemoveConsole)(); return;}+#endif+ 	if (SIOUXState == OFF || !SIOUXTextWindow) 		return; @@ -1297,6 +1342,10 @@ 	char aChar; 	GrafPtr saveport; +#ifdef SIOUX_PLUGIN+	if(Plugin_WriteCharsToConsole) return (*Plugin_WriteCharsToConsole)(buffer, n);+#endif+ 	if (SIOUXQuitting) 		return 0; @@ -1437,6 +1486,10 @@ 	Handle textHandle; #endif /* SIOUX_USE_WASTE */ +#ifdef SIOUX_PLUGIN+	if(Plugin_ReadCharsFromConsole) return (*Plugin_ReadCharsFromConsole)(buffer, n);+#endif+ 	if (SIOUXQuitting) 		return 0; @@ -1549,6 +1602,10 @@ { 	/*	all streams have the same name ...*/ 	static char *__SIOUXDeviceName = "SIOUX";++#ifdef SIOUX_PLUGIN+	if(Plugin___ttyname) return (*Plugin___ttyname)(fildes);+#endif 	 	if (fildes >= 0 && fildes <= 2) 		return (__SIOUXDeviceName);@@ -1582,6 +1639,9 @@ int kbhit(void) {       EventRecord event;  +#ifdef SIOUX_PLUGIN+	if(Plugin_kbhit) return (*Plugin_kbhit)();+#endif       return EventAvail(keyDownMask,&event);  } @@ -1596,6 +1656,9 @@ {    int c;    EventRecord event;+#ifdef SIOUX_PLUGIN+	if(Plugin_getch) return (*Plugin_getch)();+#endif    fflush(stdout);          /* Allow SIOUX response for the mouse, drag, zoom, or resize. */ 	while(!GetNextEvent(keyDownMask,&event)) @@ -1619,6 +1682,9 @@ { 	EventRecord rEvent;  +#ifdef SIOUX_PLUGIN+	if(Plugin_clrscr){ (*Plugin_clrscr)(); return;}+#endif 	fflush(stdout); 	rEvent.what 	 = keyDown; 	rEvent.when 	 = TickCount( );